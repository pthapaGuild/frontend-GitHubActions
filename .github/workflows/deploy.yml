name: Deploy
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  extract_pull_request_number:
    runs-on: ubuntu-latest
    outputs:
      pull_request_number: ${{ steps.extract_pull_request_number.outputs.pull_request_number }}
    steps:
      - name: Extract Pull Request Number
        id: extract_pull_request_number
        uses: actions/github-script@v2.1.0
        env:
          PULL_NUMBER: ${{ github.event.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const prNumber = process.env.PULL_NUMBER.toString();
            console.log(`PULL_REQUEST_NUMBER=${prNumber}`); // Output to environment file
            core.setOutput('pull_request_number', prNumber);

  trigger_workflow:
    runs-on: ubuntu-latest
    needs: [extract_pull_request_number]
    steps:
      - name: Dispatch Event
        id: dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.E2E_CYPRESS_TESTS }}
          repository: pthapaGuild/frontend-GitHubActions
          event-type: pr-input
          client-payload: '{"prNumber": "${{ needs.extract_pull_request_number.outputs.pull_request_number }}"}'

  trigger_external_test:
    name: Run Web App
    needs: [trigger_workflow]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Workflow and Wait
        run: |
          echo "Test is running"
          sleep 10s
      - uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: pthapaGuild
          repo: backend-GitHubActions
          github_token: ${{ secrets.E2E_CYPRESS_TESTS }}
          workflow_file_name: deploy.yml
      # - name: Deploy Web App
      #   run: |
      #     echo "Deploy Web App"
      #     sleep 10s

  run_deploy_pipeline:
    needs: [trigger_external_test, extract_pull_request_number]
    runs-on: ubuntu-latest
    steps:
      - name: Print Pull Request Number
        run: |
          echo "Pull Request Number: $PULL_REQUEST_NUMBER" # Access from environment file
