# name: Deploy
# on:
#   pull_request:
#     types: [opened, synchronize]

# jobs:
#   extract_pull_request_number:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Test
#         id: test_step
#         uses: actions/github-script@0.3.0
#         env:
#           PULL_NUMBER: ${{ github.event.number }}
#         with:
#           github-token: ${{ secrets.GITHUB_TOKEN }}
#           script: |
#             const core = require('@actions/core');
#             core.setOutput('PULL_NUMBER', process.env.PULL_NUMBER.toString());
#       - name: Print
#         run: |
#           echo "Pull Request Number: ${{ needs.extract_pull_request_number.outputs.PULL_NUMBER }}"

#   trigger_workflow:
#     runs-on: ubuntu-latest
#     needs: [extract_pull_request_number]
#     steps:
#       - name: Dispatch Event
#         id: dispatch
#         uses: peter-evans/repository-dispatch@v1
#         with:
#           token: ${{ secrets.E2E_CYPRESS_TESTS }}
#           repository: pthapaGuild/frontend-GitHubActions
#           event-type: pr-input
#           client-payload: '{"prNumber": "${{ needs.extract_pull_request_number.outputs.PULL_NUMBER }}"}'

#       - name: Set Pull Request Number
#         run: echo "::set-output name=prNumber::${{ steps.dispatch.outputs.prNumber }}"

#   trigger_external_test:
#     name: Run Web App
#     needs: [trigger_workflow]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Trigger Workflow and Wait
#         run: |
#           echo "Test is running"
#           sleep 10s
#       - uses: convictional/trigger-workflow-and-wait@v1.6.5
#         with:
#           owner: pthapaGuild
#           repo: backend-GitHubActions
#           github_token: ${{ secrets.E2E_CYPRESS_TESTS }}
#           workflow_file_name: deploy.yml
#       - name: Deploy Web App
#         run: |
#           echo "Deploy Web App"
#           sleep 10s

name: Deploy
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  deploy_pipeline:
    runs-on: ubuntu-latest
    needs: [extract_pull_request_number, trigger_workflow]
    steps:
      - name: Extract Pull Request Number
        id: extract_pull_request_number
        uses: actions/github-script@0.3.0
        env:
          PULL_NUMBER: ${{ github.event.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            core.setOutput('PULL_NUMBER', process.env.PULL_NUMBER.toString())

      - name: Dispatch Event
        id: trigger_workflow
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.E2E_CYPRESS_TESTS }}
          repository: pthapaGuild/frontend-GitHubActions
          event-type: pr-input
          client-payload: '{"prNumber": "${{ needs.extract_pull_request_number.outputs.PULL_NUMBER }}"}'

      - name: Wait for Workflow and Print
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: pthapaGuild
          repo: backend-GitHubActions
          github_token: ${{ secrets.E2E_CYPRESS_TESTS }}
          workflow_file_name: deploy.yml

      - name: Run Web App
        run: |
          echo "Run Web App"
          sleep 10s
